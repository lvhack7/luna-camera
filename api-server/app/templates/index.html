<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Панель аналитики: Кафе</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* … всё как у вас … (без изменений стилей) … */
    :root { /* … */ }
    html { scroll-behavior: smooth; }
    body { /* … */ }
    @keyframes pulse { /* … */ }
    .header { /* … */ }
    .grid { /* … */ }
    .card { /* … */ }
    .card:hover { /* … */ }
    .card-header { /* … */ }
    .card-header .fa-solid { /* … */ }
    .data-row { /* … */ }
    .data-row:last-child { border-bottom: none; }
    .key { color: var(--text-secondary); font-size: 0.9rem; }
    .value { font-family: var(--font-family-mono); font-weight: 600; font-size: 2.25rem; color: var(--color-primary); }
    #total .value { color: var(--color-danger); }
    .value-group { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .value-group .value { font-size: 1.5rem; }
    .value-group .key { font-size: 0.8rem; }
    .status-ok { color: var(--color-success); }
    .status-danger { color: var(--color-danger); }
    .action-button { /* … */ }
    .action-button:hover:not(:disabled) { /* … */ }
    .action-button:disabled { /* … */ }
    .status-text { /* … */ }
    .live-indicator { /* … */ }
    .live-indicator.is-live { /* … */ }
  </style>
</head>
<body>
  <header class="header">
    <span id="s" class="live-indicator"></span>
    <h1>Панель аналитики: Кафе</h1>
  </header>

  <main class="grid">
    <!-- ОБЩАЯ ЗАГРУЗКА -->
    <div class="card" id="total">
      <h3 class="card-header"><i class="fa-solid fa-users"></i>Общая загрузка</h3>
      <div class="data-row">
        <span class="key">Гостей в зале</span>
        <span id="totalCount" class="value">—</span>
      </div>
      <div class="data-row">
        <span class="key">Бариста на месте</span>
        <span id="barista" class="value">—</span>
      </div>
    </div>

    <!-- ЗАГРУЗКА ПО ЗОНАМ -->
    <div class="card">
      <h3 class="card-header"><i class="fa-solid fa-chart-pie"></i>Загрузка по зонам</h3>
      <div id="zones"></div>
    </div>

    <!-- УНИКАЛЬНЫЕ ПОСЕТИТЕЛИ -->
    <div class="card">
      <h3 class="card-header"><i class="fa-solid fa-user-check"></i>Уникальные посетители (сегодня)</h3>
      <div class="data-row">
        <span class="key">Всего уникальных</span>
        <span id="unique" class="value">—</span>
      </div>
    </div>

    <!-- КОНВЕРСИИ -->
    <div class="card">
      <h3 class="card-header"><i class="fa-solid fa-right-left"></i>Конверсии и метрики (сегодня)</h3>

      <div class="data-row">
        <span class="key">Заказ → Выдача</span>
        <div class="value-group">
          <span id="o2pC" class="value">—</span>
          <span class="key">(ср. <span id="o2pA">—</span> сек)</span>
        </div>
      </div>

      <div class="data-row">
        <span class="key">Выдача → Зал</span>
        <div class="value-group">
          <span id="p2hC" class="value">—</span>
          <span class="key">
            конверсия: <span id="p2hPct">—</span>%
            · ср. <span id="p2hA">—</span> сек
          </span>
        </div>
      </div>

      <div class="data-row">
        <span class="key">Выдача → Выход</span>
        <div class="value-group">
          <span id="p2eC" class="value">—</span>
          <span class="key">
            конверсия: <span id="p2ePct">—</span>%
            · ср. <span id="p2eA">—</span> сек
          </span>
        </div>
      </div>

      <div class="data-row">
        <span class="key">Оповещения об отсутствии</span>
        <span id="alerts" class="value">—</span>
      </div>
    </div>

    <!-- ОТЧЁТЫ -->
    <div class="card">
      <h3 class="card-header"><i class="fa-solid fa-file-arrow-down"></i>Ежедневные отчёты</h3>
      <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; flex-grow: 1;">
        Автоматический отчёт за день (08:30–24:00 ALMT) формируется в 23:59.
      </p>
      <button id="dl" class="action-button">
        <i class="fa-solid fa-download"></i> Скачать отчёт
      </button>
      <div id="dlstatus" class="status-text"></div>
    </div>
  </main>

  <script>
    const s = document.getElementById('s');
    const totalCount = document.getElementById('totalCount');
    const barista = document.getElementById('barista');
    const zones = document.getElementById('zones');
    const uniqueEl = document.getElementById('unique');
    const o2pC = document.getElementById('o2pC'); const o2pA = document.getElementById('o2pA');
    const p2hC = document.getElementById('p2hC'); const p2hA = document.getElementById('p2hA'); const p2hPct = document.getElementById('p2hPct');
    const p2eC = document.getElementById('p2eC'); const p2eA = document.getElementById('p2eA'); const p2ePct = document.getElementById('p2ePct');
    const alerts = document.getElementById('alerts');
    const dl = document.getElementById('dl');
    const dlstatus = document.getElementById('dlstatus');

    const zoneNamesRU = {
      queue: 'Очередь', hall: 'Зал', order: 'У кассы', pickup: 'У выдачи',
      hall1: 'Зал 1', hall2: 'Зал 2', exit: 'Выход', barista: 'Бариста'
    };

    const es = new EventSource('/stream/metrics');
    es.onopen = () => s.classList.add('is-live');
    es.onerror = () => s.classList.remove('is-live');

    es.onmessage = (ev) => {
      try {
        const data = JSON.parse(ev.data);

        // Общая загрузка
        totalCount.textContent = data.total_occupancy ?? '—';
        const isBaristaPresent = (data.consolidated_counts?.barista || 0) > 0;
        barista.textContent = isBaristaPresent ? 'Да' : 'Нет';
        barista.className = 'value ' + (isBaristaPresent ? 'status-ok' : 'status-danger');

        // Зоны
        zones.innerHTML = '';
        const cc = data.consolidated_counts || {};
        for (const key in cc) {
          if (key !== 'barista') {
            const div = document.createElement('div');
            div.className = 'data-row';
            const displayName = zoneNamesRU[key] || key;
            div.innerHTML = `<span class="key">${displayName}</span><span class="value" style="font-size: 1.75rem;">${cc[key]}</span>`;
            zones.appendChild(div);
          }
        }

        // KPI + проценты
        const k = data.kpis || {};
        uniqueEl.textContent = k.unique_guests ?? '—';

        o2pC.textContent = k.o2p?.count ?? '—';
        o2pA.textContent = k.o2p?.avg_s ?? '—';

        p2hC.textContent = k.p2h?.count ?? '—';
        p2hA.textContent = k.p2h?.avg_s ?? '—';
        p2hPct.textContent = (k.p2h?.pct ?? '—');

        p2eC.textContent = k.p2e?.count ?? '—';
        p2eA.textContent = k.p2e?.avg_s ?? '—';
        p2ePct.textContent = (k.p2e?.pct ?? '—');

        alerts.textContent = k.barista_alerts ?? '—';

      } catch (e) {
        console.error("Ошибка парсинга данных с сервера:", e);
      }
    };

    // Скачивание отчёта
    dl.onclick = async () => {
      dl.disabled = true;
      dlstatus.textContent = 'Запрашиваю файл...';
      try {
        const response = await fetch('/reports/latest');
        const data = await response.json();
        if (data.error) { dlstatus.textContent = data.error; return; }
        if (data.latest_report_filename) {
          dlstatus.textContent = 'Начинаю скачивание...';
          window.location.href = '/reports/download/' + data.latest_report_filename;
          setTimeout(() => dlstatus.textContent = '', 4000);
        } else {
          dlstatus.textContent = 'Отчёты не найдены.';
        }
      } catch (e) {
        console.error('Ошибка скачивания:', e);
        dlstatus.textContent = 'Не удалось загрузить отчёт.';
      } finally {
        setTimeout(() => { dl.disabled = false; }, 1000);
      }
    };
  </script>
</body>
</html>